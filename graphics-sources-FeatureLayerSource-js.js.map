{"version":3,"sources":["./node_modules/@arcgis/core/layers/graphics/sources/FeatureLayerSource.js"],"names":[],"mappings":"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","file":"graphics-sources-FeatureLayerSource-js.js","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.19/esri/copyright.txt for details.\n*/\nimport{_ as e}from\"../../../chunks/tslib.es6.js\";import t from\"../../../core/has.js\";import{fixJson as r}from\"../../../core/lang.js\";import{setDeepValue as a}from\"../../../core/object.js\";import{isSome as s,isNone as o}from\"../../../core/maybe.js\";import\"../../../core/Logger.js\";import\"../../../core/accessorSupport/ensureType.js\";import{property as i}from\"../../../core/accessorSupport/decorators/property.js\";import{subclass as u}from\"../../../core/accessorSupport/decorators/subclass.js\";import n from\"../../../core/Error.js\";import{dataComponents as l}from\"../../../core/urlUtils.js\";import\"../../../core/uuid.js\";import\"../../../portal/support/resourceExtension.js\";import d from\"../../../geometry/Extent.js\";import c from\"../../../request.js\";import h from\"../../../core/Loadable.js\";import y from\"../../../TimeExtent.js\";import{unapplyEditsZUnitScaling as p}from\"../../../rest/query/operations/zscale.js\";import{processAttachmentQueryResult as m}from\"../../../rest/query/operations/queryAttachments.js\";import f from\"../../../tasks/QueryTask.js\";import{createDrawingInfo as g}from\"./support/clientSideDefaults.js\";async function b(e){if(\"string\"==typeof e){const t=l(e);return t||{data:e}}return new Promise(((t,r)=>{const a=new FileReader;a.readAsDataURL(e),a.onload=()=>t(l(a.result)),a.onerror=e=>r(e)}))}const F=new Set([\"Feature Layer\",\"Table\"]);let R=class extends h{constructor(){super(...arguments),this.type=\"feature-layer\"}load(e){const t=s(e)?e.signal:null;return this.addResolvingPromise(this._fetchService(t)),Promise.resolve(this)}get queryTask(){const{capabilities:{query:{supportsFormatPBF:e}},parsedUrl:r,dynamicDataSource:a,gdbVersion:s,spatialReference:o,fieldsIndex:i}=this.layer,u=t(\"featurelayer-pbf\")&&e?\"pbf\":\"json\";return new f({url:r.path,format:u,fieldsIndex:i,dynamicDataSource:a,gdbVersion:s,sourceSpatialReference:o})}async addAttachment(e,t){await this.load();const r=e.attributes[this.layer.objectIdField],a=this.layer.parsedUrl.path+\"/\"+r+\"/addAttachment\",s=this._getLayerRequestOptions(),o=this._getFormDataForAttachment(t,s.query);try{const e=await c(a,{body:o});return this._createFeatureEditResult(e.data.addAttachmentResult)}catch(i){throw this._createAttachmentErrorResult(r,i)}}async updateAttachment(e,t,r){await this.load();const a=e.attributes[this.layer.objectIdField],s=this.layer.parsedUrl.path+\"/\"+a+\"/updateAttachment\",o=this._getLayerRequestOptions({query:{attachmentId:t}}),i=this._getFormDataForAttachment(r,o.query);try{const e=await c(s,{body:i});return this._createFeatureEditResult(e.data.updateAttachmentResult)}catch(u){throw this._createAttachmentErrorResult(a,u)}}async applyEdits(e,t){await this.load();const r=e.addFeatures.map(this._serializeFeature,this),a=e.updateFeatures.map(this._serializeFeature,this),s=this._getFeatureIds(e.deleteFeatures,null==t?void 0:t.globalIdUsed);p(r,a,this.layer.spatialReference);const o=[],i=[],u=[...e.deleteAttachments];for(const c of e.addAttachments)o.push(await this._serializeAttachment(c));for(const c of e.updateAttachments)i.push(await this._serializeAttachment(c));const n=o.length||i.length||u.length?{adds:o,updates:i,deletes:u}:null,l=this._getLayerRequestOptions({method:\"post\",query:{adds:r.length?JSON.stringify(r):null,updates:a.length?JSON.stringify(a):null,deletes:s.length?null!=t&&t.globalIdUsed?JSON.stringify(s):s.join(\",\"):null,gdbVersion:(null==t?void 0:t.gdbVersion)||this.layer.gdbVersion,rollbackOnFailure:null==t?void 0:t.rollbackOnFailureEnabled,useGlobalIds:null==t?void 0:t.globalIdUsed,attachments:n&&JSON.stringify(n)}}),d=await c(this.layer.parsedUrl.path+\"/applyEdits\",l);return this._createEditsResult(d)}async deleteAttachments(e,t){await this.load();const r=e.attributes[this.layer.objectIdField],a=this.layer.parsedUrl.path+\"/\"+r+\"/deleteAttachments\";try{return(await c(a,this._getLayerRequestOptions({query:{attachmentIds:t.join(\",\")},method:\"post\"}))).data.deleteAttachmentResults.map(this._createFeatureEditResult)}catch(s){throw this._createAttachmentErrorResult(r,s)}}fetchRecomputedExtents(e={}){const t=e.signal;return this.load({signal:t}).then((async()=>{const t=this._getLayerRequestOptions({...e,query:{returnUpdates:!0}}),{layerId:r,url:a}=this.layer,{data:s}=await c(`${a}/${r}`,t),{id:o,extent:i,fullExtent:u,timeExtent:n}=s,l=i||u;return{id:o,fullExtent:l&&d.fromJSON(l),timeExtent:n&&y.fromJSON({start:n[0],end:n[1]})}}))}async queryAttachments(e,t={}){const{parsedUrl:r}=this.layer,a=r.path;await this.load();const s=this._getLayerRequestOptions(t);if(!this.layer.get(\"capabilities.operations.supportsQueryAttachments\")){const{objectIds:t}=e,r=[];for(const e of t){const t=a+\"/\"+e+\"/attachments\";r.push(c(t,s))}return Promise.all(r).then((e=>t.map(((t,r)=>({parentObjectId:t,attachmentInfos:e[r].data.attachmentInfos}))))).then((e=>m(e,a)))}return this.queryTask.executeAttachmentQuery(e,s)}async queryFeatures(e,t){return await this.load(),this.queryTask.execute(e,{...t,query:{...this.layer.customParameters,...null==t?void 0:t.query}})}async queryFeaturesJSON(e,t){return await this.load(),this.queryTask.executeJSON(e,{...t,query:{...this.layer.customParameters,...null==t?void 0:t.query}})}async queryObjectIds(e,t){return await this.load(),this.queryTask.executeForIds(e,{...t,query:{...this.layer.customParameters,...null==t?void 0:t.query}})}async queryFeatureCount(e,t){return await this.load(),this.queryTask.executeForCount(e,{...t,query:{...this.layer.customParameters,...null==t?void 0:t.query}})}async queryExtent(e,t){return await this.load(),this.queryTask.executeForExtent(e,{...t,query:{...this.layer.customParameters,...null==t?void 0:t.query}})}async queryRelatedFeatures(e,t){return await this.load(),this.queryTask.executeRelationshipQuery(e,{...t,query:{...this.layer.customParameters,...null==t?void 0:t.query}})}async queryRelatedFeaturesCount(e,t){return await this.load(),this.queryTask.executeRelationshipQueryForCount(e,{...t,query:{...this.layer.customParameters,...null==t?void 0:t.query}})}async _fetchService(e){let r=this.layer.sourceJSON;if(!r){const{data:a}=await c(this.layer.parsedUrl.path,this._getLayerRequestOptions({query:t(\"featurelayer-advanced-symbols\")?{returnAdvancedSymbols:!0}:{},signal:e}));r=a}this.sourceJSON=this._patchServiceJSON(r);const a=r.type;if(!F.has(a))throw new n(\"feature-layer-source:unsupported-type\",`Source type \"${a}\" is not supported`)}_patchServiceJSON(e){var t;if(\"Table\"!==e.type&&e.geometryType&&(null==e||null==(t=e.drawingInfo)||!t.renderer)&&!e.defaultSymbol){const t=g(e.geometryType).renderer;a(\"drawingInfo.renderer\",t,e)}return e}_serializeFeature(e){const{geometry:t,attributes:r}=e;return o(t)?{attributes:r}:\"mesh\"===t.type||\"extent\"===t.type?null:{geometry:t.toJSON(),attributes:r}}async _serializeAttachment(e){const{feature:t,attachment:r}=e,{globalId:a,name:s,contentType:o,data:i,uploadId:u}=r,n={globalId:a,parentGlobalId:null,contentType:null,name:null,uploadId:null,data:null};if(t&&(n.parentGlobalId=\"attributes\"in t?t.attributes&&t.attributes[this.layer.globalIdField]:t.globalId),u)n.uploadId=u;else if(i){const e=await b(i);n.contentType=e.mediaType,n.data=e.data,i instanceof File&&(n.name=i.name)}return s&&(n.name=s),o&&(n.contentType=o),n}_getFeatureIds(e,t){const r=e[0];return r?this._canUseGlobalIds(t,e)?this._getGlobalIdsFromFeatureIdentifier(e):\"objectId\"in r?this._getObjectIdsFromFeatureIdentifier(e):this._getIdsFromFeatures(e):[]}_getIdsFromFeatures(e){const t=this.layer.objectIdField;return e.map((e=>e.attributes&&e.attributes[t]))}_canUseGlobalIds(e,t){return e&&\"globalId\"in t[0]}_getObjectIdsFromFeatureIdentifier(e){return e.map((e=>e.objectId))}_getGlobalIdsFromFeatureIdentifier(e){return e.map((e=>e.globalId))}_createEditsResult(e){const t=e.data,r=e.data&&e.data.attachments;return{addFeatureResults:t.addResults?t.addResults.map(this._createFeatureEditResult,this):[],updateFeatureResults:t.updateResults?t.updateResults.map(this._createFeatureEditResult,this):[],deleteFeatureResults:t.deleteResults?t.deleteResults.map(this._createFeatureEditResult,this):[],addAttachmentResults:r&&r.addResults?r.addResults.map(this._createFeatureEditResult,this):[],updateAttachmentResults:r&&r.updateResults?r.updateResults.map(this._createFeatureEditResult,this):[],deleteAttachmentResults:r&&r.deleteResults?r.deleteResults.map(this._createFeatureEditResult,this):[]}}_createFeatureEditResult(e){const t=!0===e.success?null:e.error||{code:void 0,description:void 0};return{objectId:e.objectId,globalId:e.globalId,error:t?new n(\"feature-layer-source:edit-failure\",t.description,{code:t.code}):null}}_createAttachmentErrorResult(e,t){const r=t.details.messages&&t.details.messages[0]||t.message,a=t.details.httpStatus||t.details.messageCode;return{objectId:e,globalId:null,error:new n(\"feature-layer-source:attachment-failure\",r,{code:a})}}_getFormDataForAttachment(e,t){const r=e instanceof FormData?e:e&&e.elements?new FormData(e):null;if(r)for(const a in t){const e=t[a];null!=e&&(r.set?r.set(a,e):r.append(a,e))}return r}_getLayerRequestOptions(e={}){const{parsedUrl:t,gdbVersion:a,dynamicDataSource:s}=this.layer;return{...e,query:r({gdbVersion:a,layer:s?JSON.stringify({source:s}):void 0,...t.query,f:\"json\",...this.layer.customParameters,...null==e?void 0:e.query}),responseType:\"json\"}}};e([i()],R.prototype,\"type\",void 0),e([i({constructOnly:!0})],R.prototype,\"layer\",void 0),e([i({readOnly:!0})],R.prototype,\"queryTask\",null),R=e([u(\"esri.layers.graphics.sources.FeatureLayerSource\")],R);var q=R;export default q;\n"],"sourceRoot":"webpack:///"}